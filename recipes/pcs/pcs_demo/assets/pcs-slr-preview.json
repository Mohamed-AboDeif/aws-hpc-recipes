{
    "Resources": {
        "pcsServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "us-east-1.skywbs.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-east-1.skydp.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-east-1.skyngm.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-east-2.skywbs.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-east-2.skydp.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-east-2.skyngm.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-west-2.skywbs.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-west-2.skydp.cbb.skyb.gamma.alameda.aws.internal",
                                    "us-west-2.skyngm.cbb.skyb.gamma.alameda.aws.internal"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "Policies": [
                    {
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Sid": "PermissionsToCreatePCSNetworkInterfaces",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateNetworkInterface"
                                    ],
                                    "Resource": "arn:aws:ec2:*:*:network-interface/*",
                                    "Condition": {
                                        "Null": {
                                            "aws:RequestTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToCreatePCSNetworkInterfacesInSubnet",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateNetworkInterface"
                                    ],
                                    "Resource": [
                                        "arn:aws:ec2:*:*:subnet/*",
                                        "arn:aws:ec2:*:*:security-group/*"
                                    ]
                                },
                                {
                                    "Sid": "PermissionsToManagePCSNetworkInterfaces",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:CreateNetworkInterfacePermission"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "Null": {
                                                "aws:ResourceTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToDescribePCSResources",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeVpcs",
                                        "ec2:DescribeLaunchTemplates",
                                        "ec2:DescribeLaunchTemplateVersions",
                                        "ec2:DescribeInstances",
                                        "ec2:DescribeInstanceStatus",
                                        "ec2:DescribeInstanceAttribute",
                                        "ec2:DescribeInstanceTypes",
                                        "ec2:DescribeSecurityGroups",
                                        "ec2:DescribeKeyPairs",
                                        "ec2:DescribeImages",
                                        "ec2:DescribeImageAttribute"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Sid": "PermissionsToCreatePCSLaunchTemplates",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateLaunchTemplate"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "Null": {
                                            "aws:RequestTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToManagePCSLaunchTemplates",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DeleteLaunchTemplate",
                                        "ec2:CreateLaunchTemplateVersion"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "Null": {
                                            "aws:ResourceTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToTerminatePCSManagedInstances",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:TerminateInstances"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "Null": {
                                            "aws:ResourceTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToPassRoleToEC2",
                                    "Effect": "Allow",
                                    "Action": "iam:PassRole",
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "iam:PassedToService": [
                                                "ec2.amazonaws.com",
                                                "ec2.amazonaws.com.cn"
                                            ]
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToCreateEC2SLR",
                                    "Effect": "Allow",
                                    "Action": "iam:CreateServiceLinkedRole",
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "iam:AWSServiceName": [
                                                "spot.amazonaws.com",
                                                "spotfleet.amazonaws.com",
                                                "ec2fleet.amazonaws.com"
                                            ]
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToControlClusterInstanceAttributes",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:RunInstances",
                                        "ec2:CreateFleet"
                                    ],
                                    "Resource": [
                                        "arn:aws:ec2:*::image/*",
                                        "arn:aws:ec2:*::snapshot/*",
                                        "arn:aws:ec2:*:*:subnet/*",
                                        "arn:aws:ec2:*:*:network-interface/*",
                                        "arn:aws:ec2:*:*:security-group/*",
                                        "arn:aws:ec2:*:*:volume/*",
                                        "arn:aws:ec2:*:*:key-pair/*",
                                        "arn:aws:ec2:*:*:launch-template/*",
                                        "arn:aws:ec2:*:*:placement-group/*",
                                        "arn:aws:ec2:*:*:capacity-reservation/*",
                                        "arn:aws:resource-groups:*:*:group/*",
                                        "arn:aws:ec2:*:*:fleet/*"
                                    ]
                                },
                                {
                                    "Sid": "PermissionsToProvisionClusterInstances",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:RunInstances",
                                        "ec2:CreateFleet"
                                    ],
                                    "Resource": [
                                        "arn:aws:ec2:*:*:instance/*"
                                    ],
                                    "Condition": {
                                        "Null": {
                                            "aws:RequestTag/AWSPCSManaged": "false"
                                        }
                                    }
                                },
                                {
                                    "Sid": "PermissionsToTagPCSResources",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateTags"
                                    ],
                                    "Resource": [
                                        "*"
                                    ],
                                    "Condition": {
                                        "StringEquals": {
                                            "ec2:CreateAction": [
                                                "RunInstances",
                                                "CreateLaunchTemplate",
                                                "CreateFleet",
                                                "CreateNetworkInterface"
                                            ]
                                        }
                                    }
                                }
                            ],
                            "Version": "2012-10-17"
                        },
                        "PolicyName": "pcsServicePolicy"
                    }
                ],
                "RoleName": { "Fn::Sub" : "dpip-vendor-slr-${AWS::Region}" }
            }
        }
    }
}